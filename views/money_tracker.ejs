<div id="moneytracker-main-content">

    <% if(user!=="email" ){ %>

        <h1 id="moneytracker-title">üí∏ Monthly Money Tracker</h1>

        <!-- üîπ Chart Placeholder -->
        <canvas id="moneytracker-expense-chart"></canvas>

        <!-- üîπ Summary -->
        <% let all_months = user.money_manager %>
        <%  all_months=all_months.sort((a, b) => b.month.localeCompare(a.month)); %>
       <% let latest_month = all_months[0] %>
            <h2>All This Data will be of Current Month.....</h2>
            <section class="moneytracker-summary">
                <div class="moneytracker-summary-box">Income: <span id="moneytracker-sum-income">‚Çπ
                        <% if (latest_month) { %>
                            <%= latest_month.income %>
                                <% }else{ %>
                                    0
                                    <% } %>
                    </span></div>
                <div class="moneytracker-summary-box">Budget: <span id="moneytracker-sum-budget">‚Çπ
                        <% if (latest_month) { %>
                            <%= latest_month.budget %>
                                <% }else{ %>
                                    0
                                    <% } %>
                    </span></div>
                <div class="moneytracker-summary-box">Expenses: <span id="moneytracker-sum-expenses">‚Çπ
                        <% if (latest_month) { %>
                            <%= latest_month.expense %>
                                <% }else{ %>
                                    0
                                    <% } %>
                    </span></div>
                <div class="moneytracker-summary-box">Balance: <span id="moneytracker-sum-balance">‚Çπ
                        <% if (latest_month) { %>
                            <%= latest_month.balance %>
                                <% }else{ %>
                                    0
                                    <% } %>
                    </span></div>
            </section>

            <!-- üîπ Setup Monthly Budget & Income -->
            <% if (!user.currnet_month_exist) { %>
                <h2>
                    You Haven't Set Up This Month! Make it quick......
                </h2>
                <form class="moneytracker-month-setup" method="post" action="/money_tracker/setupofmonth">
                    <label>
                        Income:
                        <input type="number" name="income" required id="moneytracker-income-input"
                            placeholder="‚Çπ e.g. 6000" />
                    </label>
                    <label>
                        Budget:
                        <input type="number" name="budget" required id="moneytracker-budget-input"
                            placeholder="‚Çπ e.g. 5000" />
                    </label>
                    <button id="moneytracker-set-month-btn">Set Current Month</button>
                </form>
                <% } %>





                    <% let now=new Date(); %>
                        <% let year=now.getFullYear(); %>
                            <% let month=(now.getMonth() + 1).toString().padStart(2, '0' ); %>
                                <% let firstDay=`${year}-${month}-01`; %>
                                    <% let lastDay=new Date(year, month, 0).toISOString().slice(0, 10); %>


                                        <!-- üîπ Add Expense -->
                                        <form class="moneytracker-expense-form" id="moneytracker-expense-form-id"
                                            action="/money_tracker/add_expense_record" method="post">
                                            <h2 id="moneytracker-expense-title">Add Expense</h2>
                                            <input type="date" min="<%= firstDay %>" max="<%= lastDay %>" name="date"
                                                id="moneytracker-expense-date" required />
                                            <input type="text" name="description" id="moneytracker-expense-desc"
                                                required placeholder="Reason" />
                                            <input type="number" name="amount" id="moneytracker-expense-amount" required
                                                placeholder="‚Çπ Amount" />
                                            <select id="moneytracker-expense-category" required name="category">
                                                <option value="üçï Food">üçï Food</option>
                                                <option value="üè† Rent">üè† Rent</option>
                                                <option value="üì± Recharge">üì± Recharge</option>
                                                <option value="üì¶ Misc">üì¶ Misc</option>
                                                <option value="‚úàÔ∏è Travel">‚úàÔ∏è Travel</option>
                                                <option value="üõçÔ∏è Shopping">üõçÔ∏è Shopping</option>
                                                <option value="ü©∫ Health">ü©∫ Health</option>
                                                <option value="üìö Education">üìö Education</option>
                                                <option value="üõí Groceries">üõí Groceries</option>
                                                <option value="üí° Bills">üí° Bills</option>
                                                <option value="üì∫ Subscriptions">üì∫ Subscriptions</option>
                                                <option value="üöå Transportation">üöå Transportation</option>
                                                <option value="üéÅ Gifts">üéÅ Gifts</option>
                                                <option value="üé¨ Entertainment">üé¨ Entertainment</option>
                                                <option value="üçü Snacks">üçü Snacks</option>
                                                <option value="üí∞ Savings">üí∞ Savings</option>
                                                <option value="üìÑ EMI">üìÑ EMI</option>
                                                <option value="üê∂ Pet Care">üê∂ Pet Care</option>
                                                <option value="üß¥ Personal Care">üß¥ Personal Care</option>
                                                <option value="üß∫ Laundry">üß∫ Laundry</option>
                                                <option value="üñäÔ∏è Stationery">üñäÔ∏è Stationery</option>
                                                <option value="üìà Investment">üìà Investment</option>
                                                <option value="üôè Charity">üôè Charity</option>
                                                <option value="üö® Emergency">üö® Emergency</option>
                                            </select>

                                            <button id="moneytracker-add-expense-btn">‚ûï Add Expense</button>
                                        </form>



                                        <!-- üîπ Expense Records -->
                                        <section class="moneytracker-record-section">
                                            <h2 id="moneytracker-record-title">Expense Records</h2>
                                            <table id="moneytracker-expense-table">
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Description</th>
                                                        <th>Amount</th>
                                                        <th>Category</th>
                                                        <th>‚ùå</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="moneytracker-expense-table-body">
                                                    <% if(latest_month){ %>
                                                        <% let data=latest_month.expense_record %>
                                                            <% if (data.length !==0) { %>
                                                                <% data.sort((a, b)=> new Date(b.date) - new
                                                                    Date(a.date)) %>
                                                                    <% data.forEach(data=> { %>
                                                                        <tr>
                                                                            <td>
                                                                                <%= data.date.toDateString() %>
                                                                            </td>
                                                                            <td>
                                                                                <%= data.description %>
                                                                            </td>
                                                                            <td style="color: red;font-weight: bolder;">
                                                                                <%= data.amount %>
                                                                            </td>
                                                                            <td>
                                                                                <%= data.category %>
                                                                            </td>
                                                                            <td>
                                                                                <form
                                                                                    action="/money_tracker/expense_record_delete"
                                                                                    method="post">
                                                                                    <input type="hidden" name="_id"
                                                                                        value="<%= data._id %>">
                                                                                    <button
                                                                                        style="background-color: transparent;">‚ùå</button>
                                                                                </form>
                                                                            </td>
                                                                        </tr>
                                                                        <% }); %>
                                                                            <% }else{ %>
                                                                                <tr>
                                                                                    <td colspan="5">No Record
                                                                                        Available......... for
                                                                                        This
                                                                                        Month</td>
                                                                                </tr>
                                                                                <% } %>
                                                                                    <% }else{ %>
                                                                                        <tr>
                                                                                            <td colspan="5">No
                                                                                                Record
                                                                                                Available.........
                                                                                                for
                                                                                                This
                                                                                                Month</td>
                                                                                        </tr>
                                                                                        <% } %>
                                                </tbody>
                                            </table>
                                        </section>


                                        <!-- üîπ Add Income -->
                                        <form class="moneytracker-expense-form" id="moneytracker-income-form-id"
                                            action="/money_tracker/add_income_record" method="post">

                                            <h2 id="moneytracker-expense-title">Add Income</h2>

                                            <input type="date" min="<%= firstDay %>" max="<%= lastDay %>" name="date"
                                                id="moneytracker-expense-date" required />

                                            <input type="number" name="amount" id="moneytracker-expense-amount" required
                                                placeholder="‚Çπ Amount" />

                                            <select id="moneytracker-expense-category" required name="category">
                                                <option value="üìà Last Month Balance">üìà Last Month Balance</option>
                                                <option value="üíº Salary">üíº Salary</option>
                                                <option value="üßë‚Äçüíª Freelance">üßë‚Äçüíª Freelance</option>
                                                <option value="üéì Scholarship">üéì Scholarship</option>
                                                <option value="üéÅ Gift">üéÅ Gift</option>
                                                <option value="üè¶ Interest">üè¶ Interest</option>
                                                <option value="üìà Investment Return">üìà Investment Return
                                                </option>
                                                <option value="üè† Rental Income">üè† Rental Income</option>
                                                <option value="üõçÔ∏è Business">üõçÔ∏è Business</option>
                                                <option value="‚ûï Others">‚ûï Others</option>
                                            </select>


                                            <button id="moneytracker-add-expense-btn">‚ûï Add Income</button>
                                        </form>






                                        <% data=user.money_manager.income_record %>
                                            <!-- üîπ income Records -->
                                            <section class="moneytracker-record-section">
                                                <h2 id="moneytracker-record-title">Income Records</h2>
                                                <table id="moneytracker-expense-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Amount</th>
                                                            <th>Category</th>
                                                            <th>‚ùå</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="moneytracker-expense-table-body">
                                                        <% if(latest_month){ %>
                                                            <% let data=latest_month.income_record %>
                                                                <% if (data.length !==0) { %>
                                                                    <% data.sort((a, b)=> new Date(b.date) - new
                                                                        Date(a.date)) %>
                                                                        <% data.forEach(data=> { %>
                                                                            <tr>
                                                                                <td>
                                                                                    <%= data.date.toDateString() %>
                                                                                </td>
                                                                                <td
                                                                                    style="color: green;font-weight: bolder;">
                                                                                    <%= data.amount %>
                                                                                </td>
                                                                                <td>
                                                                                    <%= data.category %>
                                                                                </td>
                                                                                <td>
                                                                                    <form
                                                                                        action="/money_tracker/income_record_delete"
                                                                                        method="post">
                                                                                        <input type="hidden" name="_id"
                                                                                            value="<%= data._id %>">
                                                                                        <button
                                                                                            style="background-color: transparent;">‚ùå</button>
                                                                                    </form>
                                                                                </td>
                                                                            </tr>
                                                                            <% }); %>
                                                                                <% }else{ %>
                                                                                    <tr>
                                                                                        <td colspan="3">No
                                                                                            Record
                                                                                            Available.........
                                                                                            for
                                                                                            This
                                                                                            Month</td>
                                                                                    </tr>
                                                                                    <% } %>
                                                                                        <% }else{ %>
                                                                                            <tr>
                                                                                                <td colspan="3">
                                                                                                    No
                                                                                                    Record
                                                                                                    Available.........
                                                                                                    for
                                                                                                    This
                                                                                                    Month</td>
                                                                                            </tr>
                                                                                            <% } %>
                                                    </tbody>
                                                </table>
                                            </section>


                                            <% }else{ %>

                                                <section class="welcome-card" style="margin-top: 18vh;">
                                                    <h2>üëã Welcome!</h2>
                                                    <p>Get <strong>logged in</strong> to explore more features like your
                                                        To-do list, Timetable, and
                                                        Important
                                                        Countdown.</p>
                                                    <a href="/login" class="action-btn">Log In</a>
                                                </section>

                                                <% } %>

</div>